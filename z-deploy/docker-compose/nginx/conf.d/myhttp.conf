upstream mysvr {
      server 127.0.0.1:7878;
      server 192.168.10.121:3333 backup;  #热备
}

server {
        keepalive_requests 120; #单连接请求上限次数。
        listen       4545;   #监听端口
        server_name  127.0.0.1;   #监听地址
        location  ~*^.+$ {       #请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。
           #root path;  #根目录
           #index vv.txt;  #设置默认页
           proxy_pass  http://mysvr;  #请求转向mysvr 定义的服务器列表
           deny 127.0.0.1;  #拒绝的ip
           allow 172.18.5.54; #允许的ip
        }
}

server {
    # SSL 访问端口
    listen      443 ssl;
    # 绑定证书域名
    server_name jjyard.xyz;
    # 证书文件
    ssl_certificate     /etc/letsencrypt/8492108_baby.i.hongyanyun.cn.pem;
    # 私钥文件
    ssl_certificate_key /etc/letsencrypt/8492108_baby.i.hongyanyun.cn.key;
    ssl_session_timeout 5m;
    # 配置协议
    ssl_protocols       TLSv1.2 TLSv1.3;
    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;
    location / {
        root    /usr/share/nginx/html;
        index   index.html index.htm;
    }
}


server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    location ~.*\.(html|htm)$
    {
        add_header Cache-Control no-cache;
    }

    #注意在容器内部映射文件
    location /upload/
    {
        alias  /usr/share/nginx/html/upload/;
        #autoindex on;
    }

    location ^~ /api/ {
                proxy_http_version 1.1;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Accept-Encoding 'gzip';
                proxy_set_header Connection "upgrade";
                add_header Access-Control-Expose-Headers "token";
                proxy_pass http://10.0.40.66:8088/;
   }

    location ^~ /websocket/ {
                proxy_http_version 1.1;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Accept-Encoding 'gzip';
                proxy_set_header Connection "upgrade";
                proxy_connect_timeout 5s;
                proxy_read_timeout 300s;
                proxy_send_timeout 5s;
                add_header Access-Control-Expose-Headers "token";

                proxy_pass http://10.0.40.66:8088/;
   }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

